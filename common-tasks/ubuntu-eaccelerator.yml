---
##
# eAccelerator for PHP, an opcode cache. If you change this to a new version,
# remember to change the paths all the way through.
#
# Ubuntu only.
#
- name: eAccelerator | Grab php development package
  action: apt pkg=php5-dev state=installed
  tags: eaccel

- name: eAccelerator | Download the zip
  action: get_url url=http://downloads.sourceforge.net/project/eaccelerator/eaccelerator/eAccelerator%200.9.6.1/eaccelerator-0.9.6.1.zip dest=/root/eaccelerator-0.9.6.1.zip
  tags: eaccel

- name: eAccelerator | Unarchive the zip
  action: command unzip /root/eaccelerator-0.9.6.1.zip chdir=/root creates=/root/eaccelerator-0.9.6.1
  tags: eaccel

- name: eAccelerator | PHPize
  action: command phpize chdir=/root/eaccelerator-0.9.6.1 creates=/root/eaccelerator-0.9.6.1/configure
  tags: eaccel

- name: eAccelerator | Configure
  action: command ./configure chdir=/root/eaccelerator-0.9.6.1 creates=/root/eaccelerator-0.9.6.1/config.status
  tags: eaccel

- name: eAccelerator | Make
  action: command make chdir=/root/eaccelerator-0.9.6.1 creates=/root/eaccelerator-0.9.6.1/modules/eaccelerator.so
  tags: eaccel

- name: eAccelerator | Install
  action: command make install chdir=/root/eaccelerator-0.9.6.1 creates=/usr/lib/php5/20090626/eaccelerator.so
  tags: eaccel

- name: eAccelerator | Copy config for PHP
  action: template src=templates/etc-php5-conf-d-eaccelerator-ini.j2 dest=/etc/php5/conf.d/eaccelerator.ini
  tags: eaccel

- name: eAccelerator | Make a cache directory
  action: file path=/var/cache/eaccelerator state=directory owner=www-data mode=700
  tags: eaccel

- name: eAccelerator | Make a log file
  action: file path=/var/log/eaccelerator.log state=file owner=www-data mode=666
  tags: eaccel

- name: eAccelerator | Configure the kernel max shm size to support large memory allocation.
  action: copy src=files/etc-sysctl-d-65-shm-size-conf dest=/etc/sysctl.d/65-shm-size.conf
  tags: eaccel

- name: eAccelerator | Configure the kernel max shm size to support large memory allocation.
  action: shell echo "260000000" > /proc/sys/kernel/shmmax
  tags: eaccel
